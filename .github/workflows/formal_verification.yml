name: Formal Verification Tests

# Run on push to main and all pull requests
on:
  push:
    branches: [ main, develop ]
    paths:
      - 'swaptrade-contracts/**'
      - 'tests/formal_verification_tests.rs'
      - '.github/workflows/formal_verification.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'swaptrade-contracts/**'
      - 'tests/formal_verification_tests.rs'

jobs:
  formal-verification:
    name: Formal Verification Tests
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            swaptrade-contracts/counter

      - name: Run Formal Verification Unit Tests
        run: |
          cd swaptrade-contracts/counter
          cargo test formal_verification:: --lib -- --nocapture --test-threads=1
        timeout-minutes: 10

      - name: Run Exhaustive Property Tests (10,000+ sequences)
        run: |
          cd swaptrade-contracts/counter
          cargo test exhaustive_ --lib -- --nocapture --test-threads=1
        timeout-minutes: 30

      - name: Run Witness Cases
        run: |
          cd swaptrade-contracts/counter
          cargo test witness_case --lib -- --nocapture --test-threads=1
        timeout-minutes: 10

      - name: Run All Formal Verification Tests
        run: |
          cd swaptrade-contracts/counter
          cargo test formal_verification -- --nocapture
        timeout-minutes: 5

      - name: Verify Release Build (no panics)
        run: |
          cd swaptrade-contracts/counter
          cargo build --release
        timeout-minutes: 15

      - name: Run Clippy for security issues
        run: |
          cd swaptrade-contracts/counter
          cargo clippy --lib -- -D warnings
        timeout-minutes: 10

  property-test-coverage:
    name: Property Test Coverage Report
    runs-on: ubuntu-latest
    needs: formal-verification
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install tarpaulin for coverage
        run: cargo install cargo-tarpaulin

      - name: Generate test coverage report
        run: |
          cd swaptrade-contracts/counter
          cargo tarpaulin --lib --out Html --exclude-files tests/ --timeout 300
        timeout-minutes: 15
        continue-on-error: true

      - name: Upload coverage report
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: coverage-report
          path: swaptrade-contracts/counter/tarpaulin-report.html

  security-audit:
    name: Security Audit (Cargo Audit)
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-audit
        run: cargo install cargo-audit

      - name: Run Cargo Audit
        run: cargo audit
        continue-on-error: true

  invariant-predicate-test:
    name: Invariant Predicate Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Test Invariant Predicates
        run: |
          cd swaptrade-contracts/counter
          cargo test property_ --lib -- --nocapture --test-threads=1
        timeout-minutes: 15

  summary:
    name: Formal Verification Summary
    runs-on: ubuntu-latest
    needs: [formal-verification, security-audit, invariant-predicate-test]
    if: always()

    steps:
      - name: Check Formal Verification Status
        run: |
          if [ "${{ needs.formal-verification.result }}" == "failure" ]; then
            echo "❌ Formal Verification Tests FAILED"
            exit 1
          else
            echo "✅ Formal Verification Tests PASSED"
          fi

      - name: Check Security Audit Status
        run: |
          if [ "${{ needs.security-audit.result }}" == "failure" ]; then
            echo "⚠️  Security Audit detected issues (non-blocking)"
          else
            echo "✅ Security Audit passed"
          fi

      - name: Check Invariant Predicates Status
        run: |
          if [ "${{ needs.invariant-predicate-test.result }}" == "failure" ]; then
            echo "❌ Invariant Predicate Tests FAILED"
            exit 1
          else
            echo "✅ Invariant Predicate Tests PASSED"
          fi

      - name: Comment PR with Results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const formal_status = "${{ needs.formal-verification.result }}" === "success" ? "✅" : "❌";
            const security_status = "${{ needs.security-audit.result }}" === "success" ? "✅" : "⚠️";
            const invariant_status = "${{ needs.invariant-predicate-test.result }}" === "success" ? "✅" : "❌";
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## Formal Verification Report
            
            | Check | Status |
            |-------|--------|
            | Formal Verification Tests | ${formal_status} |
            | Security Audit | ${security_status} |
            | Invariant Predicates | ${invariant_status} |
            
            > Formal verification tests passed with 10,000+ random sequences covering asset conservation, authorization invariants, state monotonicity, and fee bounds.`
            });
